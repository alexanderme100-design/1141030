<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生上下學方式分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 確保 canvas 在響應式佈局中正常顯示 */
        #commuteChart, #walkingTrendChart, #keyMethodsChart {
            max-width: 100%;
            height: auto !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
                
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">學生上下學方式互動分析</h1>
                
        <div class="mb-6 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <label for="gradeFilter" class="text-lg font-medium text-gray-700">選擇年級：</label>
            <select id="gradeFilter" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 w-full sm:w-64 p-2.5">
                </select>
        </div>

        <div class="w-full h-auto p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">所有方式 - 上下學比較</h2>
            <canvas id="commuteChart"></canvas>
        </div>

        <div class="mt-8 w-full h-auto p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">步行趨勢分析 (一到六年級)</h2>
            <canvas id="walkingTrendChart"></canvas>
        </div>
                
        <div class="mt-8 w-full h-auto p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">重點方式分析圖表</h2>
            <canvas id="keyMethodsChart"></canvas>
        </div>
        <div id="analysisSummary" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
            <h2 class="text-xl font-semibold text-blue-800 mb-4">圖表告訴我們：</h2>
            <div id="summaryContent" class="text-gray-700 space-y-3">
                </div>
        </div>
    </div>

    <script>
        // 1. 原始數據 (從圖片中手動提取)
        const rawData = [
            // 一年級
            { grade: '一年級', method: '其它方式', toSchool: 0, fromSchool: 0 },
            { grade: '一年級', method: '安親班接送', toSchool: 0, fromSchool: 156 },
            { grade: '一年級', method: '家長開車接送', toSchool: 44, fromSchool: 20 },
            { grade: '一年級', method: '家長陪同走路', toSchool: 72, fromSchool: 48 },
            { grade: '一年級', method: '家長騎機車接送', toSchool: 193, fromSchool: 106 },
            { grade: '一年級', method: '搭乘大眾運輸工具', toSchool: 11, fromSchool: 8 },
            { grade: '一年級', method: '自行走路', toSchool: 27, fromSchool: 17 },
            // 二年級
            { grade: '二年級', method: '其它方式', toSchool: 8, fromSchool: 6 },
            { grade: '二年級', method: '安親班接送', toSchool: 0, fromSchool: 175 },
            { grade: '二年級', method: '家長開車接送', toSchool: 53, fromSchool: 19 },
            { grade: '二年級', method: '家長陪同走路', toSchool: 57, fromSchool: 38 },
            { grade: '二年級', method: '家長騎機車接送', toSchool: 205, fromSchool: 103 },
            { grade: '二年級', method: '搭乘大眾運輸工具', toSchool: 2, fromSchool: 5 },
            { grade: '二年級', method: '自行走路', toSchool: 30, fromSchool: 20 },
            // 三年級
            { grade: '三年級', method: '其它方式', toSchool: 2, fromSchool: 1 },
            { grade: '三年級', method: '安親班接送', toSchool: 0, fromSchool: 216 },
            { grade: '三年級', method: '家長開車接送', toSchool: 53, fromSchool: 15 },
            { grade: '三年級', method: '家長陪同走路', toSchool: 52, fromSchool: 30 },
            { grade: '三年級', method: '家長騎機車接送', toSchool: 267, fromSchool: 95 },
            { grade: '三年級', method: '搭乘大眾運輸工具', toSchool: 6, fromSchool: 5 },
            { grade: '三年級', method: '自行走路', toSchool: 43, fromSchool: 68 },
            // 四年級
            { grade: '四年級', method: '其它方式', toSchool: 4, fromSchool: 1 },
            { grade: '四年級', method: '安親班接送', toSchool: 0, fromSchool: 178 },
            { grade: '四年級', method: '家長開車接送', toSchool: 57, fromSchool: 17 },
            { grade: '四年級', method: '家長陪同走路', toSchool: 58, fromSchool: 42 },
            { grade: '四年級', method: '家長騎機車接送', toSchool: 242, fromSchool: 108 },
            { grade: '四年級', method: '搭乘大眾運輸工具', toSchool: 4, fromSchool: 9 },
            { grade: '四年級', method: '自行走路', toSchool: 90, fromSchool: 99 },
            // 五年級
            { grade: '五年級', method: '其它方式', toSchool: 0, fromSchool: 15 },
            { grade: '五年級', method: '安親班接送', toSchool: 0, fromSchool: 195 },
            { grade: '五年級', method: '家長開車接送', toSchool: 45, fromSchool: 13 },
            { grade: '五年級', method: '家長陪同走路', toSchool: 38, fromSchool: 30 },
            { grade: '五年級', method: '家長騎機車接送', toSchool: 240, fromSchool: 81 },
            { grade: '五年級', method: '搭乘大眾運輸工具', toSchool: 7, fromSchool: 10 },
            { grade: '五年級', method: '自行走路', toSchool: 111, fromSchool: 122 },
            // 六年級
            { grade: '六年級', method: '其它方式', toSchool: 3, fromSchool: 0 },
            { grade: '六年級', method: '安親班接送', toSchool: 0, fromSchool: 176 },
            { grade: '六年級', method: '家長開車接送', toSchool: 73, fromSchool: 33 },
            { grade: '六年級', method: '家長陪同走路', toSchool: 33, fromSchool: 28 },
            { grade: '六年級', method: '家長騎機車接送', toSchool: 234, fromSchool: 117 },
            { grade: '六年級', method: '搭乘大眾運輸工具', toSchool: 20, fromSchool: 19 },
            { grade: '六年級', method: '自行走路', toSchool: 154, fromSchool: 155 },
        ];
        const grades = ['一年級', '二年級', '三年級', '四年級', '五年級', '六年級'];
                
        // 所有方式
        const allMethods = [
            '家長騎機車接送',
            '安親班接送',
            '家長開車接送',
            '家長陪同走路',
            '自行走路',
            '搭乘大眾運輸工具',
            '其它方式'
        ];
                
        // v 重點方式 v
        const keyMethods = [
            '家長騎機車接送',
            '安親班接送',
            '家長陪同走路',
            '自行走路'
        ];
                
        let commuteChart; // 圖表實例
        let walkingTrendChart; // 折線圖實例
        let keyMethodsChart; // <-- 新的重點圖表實例
                
        const gradeFilter = document.getElementById('gradeFilter');
        const summaryContent = document.getElementById('summaryContent');
        const commuteCtx = document.getElementById('commuteChart').getContext('2d');
        const walkingCtx = document.getElementById('walkingTrendChart').getContext('2d');
        const keyMethodsCtx = document.getElementById('keyMethodsChart').getContext('2d'); // <-- 新的 canvas context

        // 2. 填入年級篩選器選項
        function populateFilter() {
            gradeFilter.innerHTML = '<option value="all">所有年級 (總和)</option>';
            grades.forEach(grade => {
                gradeFilter.innerHTML += `<option value="${grade}">${grade}</option>`;
            });
        }

        // 3. 處理數據 (根據篩選)
        function processData(selectedGrade, methodList) {
            let filteredData = [];

            if (selectedGrade === 'all') {
                // 匯總所有年級
                const summary = {};
                methodList.forEach(method => {
                    summary[method] = { toSchool: 0, fromSchool: 0 };
                });

                rawData.forEach(item => {
                    if (summary[item.method]) {
                        summary[item.method].toSchool += item.toSchool;
                        summary[item.method].fromSchool += item.fromSchool;
                    }
                });
                                
                methodList.forEach(method => {
                    filteredData.push({
                        method: method,
                        toSchool: summary[method].toSchool,
                        fromSchool: summary[method].fromSchool
                    });
                });
            } else {
                // 篩選特定年級
                filteredData = rawData
                    .filter(item => item.grade === selectedGrade && methodList.includes(item.method))
                    // 確保順序與 methodList 陣列一致
                    .sort((a, b) => methodList.indexOf(a.method) - methodList.indexOf(b.method));
            }
                        
            const labels = filteredData.map(item => item.method);
            const toSchoolData = filteredData.map(item => item.toSchool);
            const fromSchoolData = filteredData.map(item => item.fromSchool);

            return { labels, toSchoolData, fromSchoolData, filteredData };
        }

        // 4. 更新分析摘要
        function updateSummary(selectedGrade, data) { // data 來自 processData(selectedGrade, allMethods)
            let summaryHtml = '';
            let totalToSchool = data.toSchoolData.reduce((a, b) => a + b, 0);
            let totalFromSchool = data.fromSchoolData.reduce((a, b) => a + b, 0);

            // 找到上學和放學的最大值
            const toSchoolMax = Math.max(...data.toSchoolData);
            const fromSchoolMax = Math.max(...data.fromSchoolData);
                        
            const toSchoolMaxMethod = data.labels[data.toSchoolData.indexOf(toSchoolMax)];
            const fromSchoolMaxMethod = data.labels[data.fromSchoolData.indexOf(fromSchoolMax)];
                        
            // 特殊洞察：
            const afterSchoolCare = data.filteredData.find(d => d.method === '安親班接送');
            const scooter = data.filteredData.find(d => d.method === '家長騎機車接送');
            const walking = data.filteredData.find(d => d.method === '自行走路');
            const accompaniedWalking = data.filteredData.find(d => d.method === '家長陪同走路');

            // summaryHtml += `<p><strong>你正在看：</strong> ${selectedGrade === 'all' ? '所有年級' : selectedGrade}</p>`;
            summaryHtml += `<p><strong>早上上學總人數：</strong> ${totalToSchool.toLocaleString()} 人</p>`;
            summaryHtml += `<p><strong>下午放學總人數：</strong> ${totalFromSchool.toLocaleString()} 人</p>`;
            summaryHtml += `<hr class="my-3 border-blue-100">`;
                        
            summaryHtml += `<p class="text-blue-900"><strong><i class="fas fa-motorcycle"></i> 早上上學最多人 (看總表)：</strong> ${toSchoolMaxMethod} (${toSchoolMax.toLocaleString()} 人)</p>`;
                        
            summaryHtml += `<p class="text-sm text-gray-800 mt-2 p-3 bg-blue-100 rounded-lg">早上上學時段，走路、騎車、開車的人都很多，交通特別擁擠。這也代表導護志工和老師們在路口辛苦值勤，非常令人尊敬。</p>`;

            summaryHtml += `<p class="text-blue-900"><strong><i class="fas fa-school"></i> 下午放學最多人 (看總表)：</strong> ${fromSchoolMaxMethod} (${fromSchoolMax.toLocaleString()} 人)</p>`;

            if (afterSchoolCare && scooter && accompaniedWalking && walking) { 
                 summaryHtml += `<hr class="my-3 border-blue-100">`;
                summaryHtml += `<h3 class="font-semibold text-lg text-blue-800 mb-2">重點方式分析 (請參考上方的重點圖表)：</h3>`; 
                                
                summaryHtml += `<p><strong>安親班接送：</strong> 下午 <strong class="text-red-600">${afterSchoolCare.fromSchool.toLocaleString()}</strong> 人</p>`;
                                
                summaryHtml += `<p><strong>家長騎機車：</strong> 早上 <strong class="text-green-600">${scooter.toSchool.toLocaleString()}</strong> 人，下午 ${scooter.fromSchool.toLocaleString()} 人。</p>`;
                                
                summaryHtml += `<p><strong>家長陪同走路：</strong> 早上 ${accompaniedWalking.toSchool.toLocaleString()} 人，下午 ${accompaniedWalking.fromSchool.toLocaleString()} 人。</p>`;
                summaryHtml += `<p><strong>自行走路：</strong> 早上 ${walking.toSchool.toLocaleString()} 人，下午 ${walking.fromSchool.toLocaleString()} 人。</p>`;
                summaryHtml += `<p class="mt-2 italic">看起來，很多同學是「早上爸媽騎機車送，下午安親班接走」。</p>`;
            }
                        
            summaryHtml += `<hr class="my-3 border-blue-100">`;
            summaryHtml += `<h3 class="font-semibold text-lg text-blue-800 mb-2">走路趨勢 (看上面的折線圖)：</h3>`;
            summaryHtml += `<p><strong>「自行走路」：</strong> 年級越高，自己走的同學越多，大家越來越棒、越獨立了！</p>`;
            summaryHtml += `<p><strong>「家長陪同走路」：</strong> 年級越高，爸媽陪著走的同學就越少囉。</p>`;
            // // [修正] 移除 stray/duplicate 程式碼
            summaryContent.innerHTML = summaryHtml;
        }

        // 5. 初始化/更新圖表 (主要長條圖)
        function updateMainChart() {
            const selectedGrade = gradeFilter.value;
            const data = processData(selectedGrade, allMethods); // <-- 使用 allMethods

            if (commuteChart) {
                commuteChart.data.labels = data.labels;
                commuteChart.data.datasets[0].data = data.toSchoolData;
                commuteChart.data.datasets[1].data = data.fromSchoolData;
                commuteChart.options.plugins.title.text = () => `所有方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`;
                commuteChart.update();
            } else {
                commuteChart = new Chart(commuteCtx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '上學 (人數)',
                                data: data.toSchoolData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)', // 藍色
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '放學 (人數)',
                                data: data.fromSchoolData,
                                backgroundColor: 'rgba(255, 159, 64, 0.7)', // 橘色
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.2, // 調整長寬比 (原 1.8)
                        plugins: {
                            title: {
                                display: true,
                                text: () => `所有方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`,
                                font: {
                                    size: 18
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                // [修正] 調整互動模式
                                mode: 'nearest',
                                intersect: true,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} 人`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '學生人數'
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                     minRotation: 0
                                }
                            }
                        },
                        interaction: {
                            // [修正] 調整互動模式
                            mode: 'nearest',
                            intersect: true,
                        },
                        elements: {
                            bar: {
                                borderRadius: 4,
                            }
                        }
                    }
                });
            }

            // 更新分析摘要 (主圖表更新時才更新摘要)
            updateSummary(selectedGrade, data);
        }

        // 6. 建立步行趨勢折線圖 (此圖表不隨篩選器變動)
        function createWalkingTrendChart() {
            const walkingData = {
                toSchool: [],
                fromSchool: []
            };
            const accompaniedWalkingData = {
                toSchool: [],
                fromSchool: []
            };

            // 遍歷所有年級，提取步行數據
            grades.forEach(grade => {
                const gradeWalking = rawData.find(d => d.grade === grade && d.method === '自行走路');
                const gradeAccompanied = rawData.find(d => d.grade === grade && d.method === '家長陪同走路');
                                
                walkingData.toSchool.push(gradeWalking.toSchool);
                walkingData.fromSchool.push(gradeWalking.fromSchool);
                accompaniedWalkingData.toSchool.push(gradeAccompanied.toSchool);
                accompaniedWalkingData.fromSchool.push(gradeAccompanied.fromSchool);
            });

            if (walkingTrendChart) {
                walkingTrendChart.destroy(); // 如果已存在則先銷毀
            }

            walkingTrendChart = new Chart(walkingCtx, {
                type: 'line',
                data: {
                    labels: grades,
                    datasets: [
                        {
                            label: '自行走路 (上學)',
                            data: walkingData.toSchool,
                            borderColor: 'rgba(55, 126, 184, 1)', // Blue
                            backgroundColor: 'rgba(55, 126, 184, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '自行走路 (放學)',
                            data: walkingData.fromSchool,
                            borderColor: 'rgba(228, 26, 28, 1)', // Red
                            backgroundColor: 'rgba(228, 26, 28, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '家長陪同走路 (上學)',
                            data: accompaniedWalkingData.toSchool,
                            borderColor: 'rgba(77, 175, 74, 1)', // Green
                            backgroundColor: 'rgba(77, 175, 74, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '家長陪同走路 (放學)',
                            data: accompaniedWalkingData.fromSchool,
                            borderColor: 'rgba(152, 78, 163, 1)', // Purple
                            backgroundColor: 'rgba(152, 78, 163, 0.1)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5, // 調整長寬比 (原 2.2)
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} 人`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '學生人數'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '年級'
                            }
                        }
                    }
                }
            });
        }
                
        // v 7. 新增：初始化/更新 "重點方式" 圖表 v
        function updateKeyMethodsChart() {
            const selectedGrade = gradeFilter.value;
            const data = processData(selectedGrade, keyMethods); // <-- 使用 keyMethods

            if (keyMethodsChart) {
                keyMethodsChart.data.labels = data.labels;
                keyMethodsChart.data.datasets[0].data = data.toSchoolData;
                keyMethodsChart.data.datasets[1].data = data.fromSchoolData;
                keyMethodsChart.options.plugins.title.text = () => `重點方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`;
                keyMethodsChart.update();
            } else {
                keyMethodsChart = new Chart(keyMethodsCtx, {
                    type: 'bar', // 長條圖
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '上學 (人數)',
                                data: data.toSchoolData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)', // 藍色
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '放學 (人數)',
                                data: data.fromSchoolData,
                                backgroundColor: 'rgba(255, 159, 64, 0.7)', // 橘色
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y', // <-- 關鍵：設為水平長條圖
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.0, // 調整長寬比 (原 1.5)
                        plugins: {
                            title: {
                                display: true,
                                text: () => `重點方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`,
                                font: {
                                    size: 18
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                // [修正] 調整互動模式
                                mode: 'nearest',
                                intersect: true,
                                callbacks: {
                                    label: function(context) {
                                        // v 修正：讀取 x 軸的數據 (因為是水平圖)
                                        return `${context.dataset.label}: ${context.parsed.x.toLocaleString()} 人`;
                                    }
                                }
                            }
                        },
                        // [修正] 調整互動模式
                        interaction: {
                            mode: 'nearest',
                            intersect: true,
                        },
                        scales: {
                            x: { // <-- X軸 (因為是水平圖)
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '學生人數'
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            y: { // <-- Y軸
                                ticks: {
                                    autoSkip: false // 確保所有標籤都顯示
                                }
                            }
                        },
                        elements: {
                            bar: {
                                borderRadius: 4,
                            }
                        }
                    }
                });
            }
        }
        // ^ 7. 新增：初始化/更新 "重點方式" 圖表 ^

        // 8. 啟動 (原 6. 啟動)
        document.addEventListener('DOMContentLoaded', () => {
            populateFilter();
                        
            // 綁定篩選器事件
            gradeFilter.addEventListener('change', updateMainChart);
            gradeFilter.addEventListener('change', updateKeyMethodsChart); // <-- 篩選器也要控制這個新圖表
                        
            // 初始載入
            updateMainChart(); // 這會同時更新主圖表和摘要
            createWalkingTrendChart(); // 建立固定的折線圖
            updateKeyMethodsChart(); // 建立可篩選的重點圖表
        });
    </script>
</body>
</html>
