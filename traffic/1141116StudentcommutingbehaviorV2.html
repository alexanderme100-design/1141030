<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生上下學方式分析</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 載入 Font Awesome 圖示庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 確保 canvas 在響應式佈局中正常顯示 */
        #commuteChart, #walkingTrendChart, #keyMethodsChart {
            max-width: 100%;
            height: auto !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
                
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">學生上下學方式互動分析</h1>
                
        <!-- 篩選器區域 -->
        <div class="mb-6 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <label for="gradeFilter" class="text-lg font-medium text-gray-700">選擇年級：</label>
            <select id="gradeFilter" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 w-full sm:w-64 p-2.5">
                <!-- 選項將由 JavaScript 動態填入 -->
            </select>
        </div>

        <!-- 圖表容器 (主要長條圖) -->
        <div class="w-full h-auto p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">所有方式 - 上下學比較</h2>
            <canvas id="commuteChart"></canvas>
        </div>

        <!-- 步行趨勢折線圖 -->
        <div class="mt-8 w-full h-auto p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">步行趨勢分析 (一到六年級)</h2>
            <canvas id="walkingTrendChart"></canvas>
        </div>
                
        <!-- 重點方式水平長條圖 -->
        <div class="mt-8 w-full h-auto p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">重點方式分析圖表</h2>
            <canvas id="keyMethodsChart"></canvas>
        </div>

        <!-- 數據分析摘要 -->
        <div id="analysisSummary" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
            <h2 class="text-xl font-semibold text-blue-800 mb-4">圖表告訴我們：</h2>
            <!-- [修改] 套用 grid 樣式，並移除 space-y-3 (交由 gap-6 處理間距) -->
            <div id="summaryContent" class="text-gray-700 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 分析內容將由 JavaScript 動態填入 -->
            </div>
        </div>
    </div>

    <script>
        // 1. 原始數據
        const rawData = [
            // ... 數據內容省略 ...
            // 一年級
            { grade: '一年級', method: '其它方式', toSchool: 0, fromSchool: 0 },
            { grade: '一年級', method: '安親班接送', toSchool: 0, fromSchool: 156 },
            { grade: '一年級', method: '家長開車接送', toSchool: 44, fromSchool: 20 },
            { grade: '一年級', method: '家長陪同走路', toSchool: 72, fromSchool: 48 },
            { grade: '一年級', method: '家長騎機車接送', toSchool: 193, fromSchool: 106 },
            { grade: '一年級', method: '搭乘大眾運輸工具', toSchool: 11, fromSchool: 8 },
            { grade: '一年級', method: '自行走路', toSchool: 27, fromSchool: 17 },
            // 二年級
            { grade: '二年級', method: '其它方式', toSchool: 8, fromSchool: 6 },
            { grade: '二年級', method: '安親班接送', toSchool: 0, fromSchool: 175 },
            { grade: '二年級', method: '家長開車接送', toSchool: 53, fromSchool: 19 },
            { grade: '二年級', method: '家長陪同走路', toSchool: 57, fromSchool: 38 },
            { grade: '二年級', method: '家長騎機車接送', toSchool: 205, fromSchool: 103 },
            { grade: '二年級', method: '搭乘大眾運輸工具', toSchool: 2, fromSchool: 5 },
            { grade: '二年級', method: '自行走路', toSchool: 30, fromSchool: 20 },
            // 三年級
            { grade: '三年級', method: '其它方式', toSchool: 2, fromSchool: 1 },
            { grade: '三年級', method: '安親班接送', toSchool: 0, fromSchool: 216 },
            { grade: '三年級', method: '家長開車接送', toSchool: 53, fromSchool: 15 },
            { grade: '三年級', method: '家長陪同走路', toSchool: 52, fromSchool: 30 },
            { grade: '三年級', method: '家長騎機車接送', toSchool: 267, fromSchool: 95 },
            { grade: '三年級', method: '搭乘大眾運輸工具', toSchool: 6, fromSchool: 5 },
            { grade: '三年級', method: '自行走路', toSchool: 43, fromSchool: 68 },
            // 四年級
            { grade: '四年級', method: '其它方式', toSchool: 4, fromSchool: 1 },
            { grade: '四年級', method: '安親班接送', toSchool: 0, fromSchool: 178 },
            { grade: '四年級', method: '家長開車接送', toSchool: 57, fromSchool: 17 },
            { grade: '四年級', method: '家長陪同走路', toSchool: 58, fromSchool: 42 },
            { grade: '四年級', method: '家長騎機車接送', toSchool: 242, fromSchool: 108 },
            { grade: '四年級', method: '搭乘大眾運輸工具', toSchool: 4, fromSchool: 9 },
            { grade: '四年級', method: '自行走路', toSchool: 90, fromSchool: 99 },
            // 五年級
            { grade: '五年級', method: '其它方式', toSchool: 0, fromSchool: 15 },
            { grade: '五年級', method: '安親班接送', toSchool: 0, fromSchool: 195 },
            { grade: '五年級', method: '家長開車接送', toSchool: 45, fromSchool: 13 },
            { grade: '五年級', method: '家長陪同走路', toSchool: 38, fromSchool: 30 },
            { grade: '五年級', method: '家長騎機車接送', toSchool: 240, fromSchool: 81 },
            { grade: '五年級', method: '搭乘大眾運輸工具', toSchool: 7, fromSchool: 10 },
            { grade: '五年級', method: '自行走路', toSchool: 111, fromSchool: 122 },
            // 六年級
            { grade: '六年級', method: '其它方式', toSchool: 3, fromSchool: 0 },
            { grade: '六年級', method: '安親班接送', toSchool: 0, fromSchool: 176 },
            { grade: '六年級', method: '家長開車接送', toSchool: 73, fromSchool: 33 },
            { grade: '六年級', method: '家長陪同走路', toSchool: 33, fromSchool: 28 },
            { grade: '六年級', method: '家長騎機車接送', toSchool: 234, fromSchool: 117 },
            { grade: '六年級', method: '搭乘大眾運輸工具', toSchool: 20, fromSchool: 19 },
            { grade: '六年級', method: '自行走路', toSchool: 154, fromSchool: 155 },
        ];
        const grades = ['一年級', '二年級', '三年級', '四年級', '五年級', '六年級'];
                
        // 所有方式
        const allMethods = [
            '家長騎機車接送',
            '安親班接送',
            '家長開車接送',
            '家長陪同走路',
            '自行走路',
            '搭乘大眾運輸工具',
            '其它方式'
        ];
                
        // 重點方式
        const keyMethods = [
            '家長騎機車接送',
            '安親班接送',
            '家長陪同走路',
            '自行走路'
        ];
                
        let commuteChart; 
        let walkingTrendChart; 
        let keyMethodsChart; 
                
        const gradeFilter = document.getElementById('gradeFilter');
        const summaryContent = document.getElementById('summaryContent');
        const commuteCtx = document.getElementById('commuteChart').getContext('2d');
        const walkingCtx = document.getElementById('walkingTrendChart').getContext('2d');
        const keyMethodsCtx = document.getElementById('keyMethodsChart').getContext('2d');

        // 2. 填入年級篩選器選項
        function populateFilter() {
            gradeFilter.innerHTML = '<option value="all">所有年級 (總和)</option>';
            grades.forEach(grade => {
                gradeFilter.innerHTML += `<option value="${grade}">${grade}</option>`;
            });
        }

        // 3. 處理數據 (根據篩選)
        function processData(selectedGrade, methodList) {
            let filteredData = [];

            if (selectedGrade === 'all') {
                // 匯總所有年級
                const summary = {};
                methodList.forEach(method => {
                    summary[method] = { toSchool: 0, fromSchool: 0 };
                });

                rawData.forEach(item => {
                    if (summary[item.method]) {
                        summary[item.method].toSchool += item.toSchool;
                        summary[item.method].fromSchool += item.fromSchool;
                    }
                });
                                
                methodList.forEach(method => {
                    filteredData.push({
                        method: method,
                        toSchool: summary[method].toSchool,
                        fromSchool: summary[method].fromSchool
                    });
                });
            } else {
                // 篩選特定年級
                filteredData = rawData
                    .filter(item => item.grade === selectedGrade && methodList.includes(item.method))
                    .sort((a, b) => methodList.indexOf(a.method) - methodList.indexOf(b.method));
            }
                        
            const labels = filteredData.map(item => item.method);
            const toSchoolData = filteredData.map(item => item.toSchool);
            const fromSchoolData = filteredData.map(item => item.fromSchool);

            return { labels, toSchoolData, fromSchoolData, filteredData };
        }

        // 4. 更新分析摘要 (*** 已修改為兩欄式 ***)
        function updateSummary(selectedGrade, data) { 
            
            const gradeName = selectedGrade === 'all' ? '所有年級 (總和)' : selectedGrade;

            let totalToSchool = data.toSchoolData.reduce((a, b) => a + b, 0);
            let totalFromSchool = data.fromSchoolData.reduce((a, b) => a + b, 0);

            const toSchoolMax = Math.max(...data.toSchoolData);
            const fromSchoolMax = Math.max(...data.fromSchoolData);
                        
            const toSchoolMaxMethod = data.labels[data.toSchoolData.indexOf(toSchoolMax)] || 'N/A';
            const fromSchoolMaxMethod = data.labels[data.fromSchoolData.indexOf(fromSchoolMax)] || 'N/A';
                        
            const afterSchoolCare = data.filteredData.find(d => d.method === '安親班接送');
            const scooter = data.filteredData.find(d => d.method === '家長騎機車接送');
            const walking = data.filteredData.find(d => d.method === '自行走路');
            const accompaniedWalking = data.filteredData.find(d => d.method === '家長陪同走路');

            // --- [修改] 產生左欄 HTML ---
            let column1Html = `<div class="space-y-3">`;
            column1Html += `<p><strong>你正在看：</strong> ${gradeName}</p>`;
            column1Html += `<p><strong>早上上學總人數：</strong> ${totalToSchool.toLocaleString()} 人</p>`;
            column1Html += `<p><strong>下午放學總人數：</strong> ${totalFromSchool.toLocaleString()} 人</p>`;
            column1Html += `<hr class="my-3 border-blue-100">`;
            column1Html += `<p class="text-blue-900"><strong><i class="fas fa-motorcycle"></i> 早上上學最多人 (${gradeName})：</strong> ${toSchoolMaxMethod} (${toSchoolMax.toLocaleString()} 人)</p>`;
            column1Html += `<p class="text-blue-900"><strong><i class="fas fa-school"></i> 下午放學最多人 (${gradeName})：</strong> ${fromSchoolMaxMethod} (${fromSchoolMax.toLocaleString()} 人)</p>`;
            
            if (selectedGrade === 'all') { 
                column1Html += `<p class="text-sm text-gray-800 mt-2 p-3 bg-blue-100 rounded-lg">早上上學時段，走路、騎車、開車的人都很多，交通特別擁擠。這也代表導護志工和老師們在路口辛苦值勤，非常令人尊敬。</p>`;
            }
            column1Html += `</div>`; // 結束左欄

            // --- [修改] 產生右欄 HTML ---
            let column2Html = `<div class="space-y-3">`;

            if (afterSchoolCare && scooter && accompaniedWalking && walking) { 
                column2Html += `<div>`; // 包裹重點分析
                column2Html += `<h3 class="font-semibold text-lg text-blue-800 mb-2">重點方式分析 (${gradeName})：</h3>`; 
                column2Html += `<p><strong>安親班接送：</strong> 早上 ${afterSchoolCare.toSchool.toLocaleString()} 人，下午 <strong class="text-red-600">${afterSchoolCare.fromSchool.toLocaleString()}</strong> 人</p>`;
                column2Html += `<p><strong>家長騎機車：</strong> 早上 <strong class="text-green-600">${scooter.toSchool.toLocaleString()}</strong> 人，下午 ${scooter.fromSchool.toLocaleString()} 人。</p>`;
                column2Html += `<p><strong>家長陪同走路：</strong> 早上 ${accompaniedWalking.toSchool.toLocaleString()} 人，下午 ${accompaniedWalking.fromSchool.toLocaleString()} 人。</p>`;
                column2Html += `<p><strong>自行走路：</strong> 早上 ${walking.toSchool.toLocaleString()} 人，下午 ${walking.fromSchool.toLocaleString()} 人。</p>`;
                
                if (selectedGrade === 'all') { 
                    column2Html += `<p class="mt-2 italic">看起來，很多同學是「早上爸媽騎機車送，下午安親班接走」。</p>`;
                }
                column2Html += `</div>`; // 結束重點分析
                column2Html += `<hr class="my-3 border-blue-100">`;
            } else {
                column2Html += `<hr class="my-3 border-blue-100 md:hidden">`; // 在手機上補充分隔線
            }
                        
            // 走路趨勢 (固定)
            column2Html += `<div>`; // 包裹走路趨勢
            column2Html += `<h3 class="font-semibold text-lg text-blue-800 mb-2">走路趨勢 (看上面的折線圖)：</h3>`;
            column2Html += `<p><strong>「自行走路」：</strong> 年級越高，自己走的同學越多，大家越來越棒、越獨立了！</p>`;
            column2Html += `<p><strong>「家長陪同走路」：</strong> 年級越高，爸媽陪著走的同學就越少囉。</p>`;
            column2Html += `</div>`; // 結束走路趨勢
            column2Html += `</div>`; // 結束右欄

            // --- [修改] 組合兩欄 ---
            summaryContent.innerHTML = column1Html + column2Html;
        }

        // 5. 初始化/更新圖表 (主要長條圖)
        function updateMainChart() {
            const selectedGrade = gradeFilter.value;
            const data = processData(selectedGrade, allMethods); 

            if (commuteChart) {
                commuteChart.data.labels = data.labels;
                commuteChart.data.datasets[0].data = data.toSchoolData;
                commuteChart.data.datasets[1].data = data.fromSchoolData;
                commuteChart.options.plugins.title.text = () => `所有方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`;
                commuteChart.update();
            } else {
                commuteChart = new Chart(commuteCtx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '上學 (人數)',
                                data: data.toSchoolData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)', 
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '放學 (人數)',
                                data: data.fromSchoolData,
                                backgroundColor: 'rgba(255, 159, 64, 0.7)', 
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.2, 
                        plugins: {
                            title: {
                                display: true,
                                text: () => `所有方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`,
                                font: { size: 18 },
                                padding: { bottom: 20 }
                            },
                            tooltip: {
                                mode: 'nearest',
                                intersect: true,
                                callbacks: {
                                    title: (tooltipItems) => tooltipItems[0].label,
                                    label: (context) => `${context.dataset.label}: ${context.parsed.y.toLocaleString()} 人`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '學生人數' },
                                ticks: { precision: 0 }
                            },
                            x: {
                                ticks: { maxRotation: 45, minRotation: 0 }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            intersect: true,
                        },
                        elements: { bar: { borderRadius: 4 } }
                    }
                });
            }
            updateSummary(selectedGrade, data);
        }

        // 6. 建立步行趨勢折線圖 (固定)
        function createWalkingTrendChart() {
            const walkingData = { toSchool: [], fromSchool: [] };
            const accompaniedWalkingData = { toSchool: [], fromSchool: [] };

            grades.forEach(grade => {
                const gradeWalking = rawData.find(d => d.grade === grade && d.method === '自行走路');
                const gradeAccompanied = rawData.find(d => d.grade === grade && d.method === '家長陪同走路');
                                
                walkingData.toSchool.push(gradeWalking.toSchool);
                walkingData.fromSchool.push(gradeWalking.fromSchool);
                accompaniedWalkingData.toSchool.push(gradeAccompanied.toSchool);
                accompaniedWalkingData.fromSchool.push(gradeAccompanied.fromSchool);
            });

            if (walkingTrendChart) {
                walkingTrendChart.destroy();
            }

            walkingTrendChart = new Chart(walkingCtx, {
                type: 'line',
                data: {
                    labels: grades,
                    datasets: [
                        {
                            label: '自行走路 (上學)',
                            data: walkingData.toSchool,
                            borderColor: 'rgba(55, 126, 184, 1)', // Blue
                            backgroundColor: 'rgba(55, 126, 184, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '自行走路 (放學)',
                            data: walkingData.fromSchool,
                            borderColor: 'rgba(228, 26, 28, 1)', // Red
                            backgroundColor: 'rgba(228, 26, 28, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '家長陪同走路 (上學)',
                            data: accompaniedWalkingData.toSchool,
                            borderColor: 'rgba(77, 175, 74, 1)', // Green
                            backgroundColor: 'rgba(77, 175, 74, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '家長陪同走路 (放學)',
                            data: accompaniedWalkingData.fromSchool,
                            borderColor: 'rgba(152, 78, 163, 1)', // Purple
                            backgroundColor: 'rgba(152, 78, 163, 0.1)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5, 
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.parsed.y.toLocaleString()} 人`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '學生人數' },
                            ticks: { precision: 0 }
                        },
                        x: {
                            title: { display: true, text: '年級' }
                        }
                    }
                }
            });
        }
                
        // 7. 初始化/更新 "重點方式" 圖表
        function updateKeyMethodsChart() {
            const selectedGrade = gradeFilter.value;
            const data = processData(selectedGrade, keyMethods); 

            if (keyMethodsChart) {
                keyMethodsChart.data.labels = data.labels;
                keyMethodsChart.data.datasets[0].data = data.toSchoolData;
                keyMethodsChart.data.datasets[1].data = data.fromSchoolData;
                keyMethodsChart.options.plugins.title.text = () => `重點方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`;
                keyMethodsChart.update();
            } else {
                keyMethodsChart = new Chart(keyMethodsCtx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '上學 (人數)',
                                data: data.toSchoolData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)', 
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '放學 (人數)',
                                data: data.fromSchoolData,
                                backgroundColor: 'rgba(255, 159, 64, 0.7)', 
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.0, 
                        plugins: {
                            title: {
                                display: true,
                                text: () => `重點方式 - ${gradeFilter.options[gradeFilter.selectedIndex].text}`,
                                font: { size: 18 },
                                padding: { bottom: 20 }
                            },
                            tooltip: {
                                mode: 'nearest',
                                intersect: true,
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${context.parsed.x.toLocaleString()} 人`
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            intersect: true,
                        },
                        scales: {
                            x: { 
                                beginAtZero: true,
                                title: { display: true, text: '學生人數' },
                                ticks: { precision: 0 }
                            },
                            y: { 
                                ticks: { autoSkip: false }
                            }
                        },
                        elements: { bar: { borderRadius: 4 } }
                    }
                });
            }
        }

        // 8. 啟動
        document.addEventListener('DOMContentLoaded', () => {
            populateFilter();
            
            gradeFilter.addEventListener('change', updateMainChart);
            gradeFilter.addEventListener('change', updateKeyMethodsChart); 
            
            updateMainChart(); 
            createWalkingTrendChart(); 
            updateKeyMethodsChart(); 
        });
    </script>
</body>
</html>
